

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Dean0731">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 多进程 # 多进程,import osimport timefrom multiprocessing import Process# 启动时必须在 if __name__ 判断下,windows 必须,其他 无限制# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# def func(args):# &amp;nbsp; &amp;nbsp; print(&quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="Dean0731&#39;s site">
<meta property="og:url" content="https://blog.dean0731.cn/2022/01/16/cnblog/python%E5%A4%9A%E7%BA%BF%E7%A8%8B/index.html">
<meta property="og:site_name" content="Dean0731&#39;s site">
<meta property="og:description" content="1 多进程 # 多进程,import osimport timefrom multiprocessing import Process# 启动时必须在 if __name__ 判断下,windows 必须,其他 无限制# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# def func(args):# &amp;nbsp; &amp;nbsp; print(&quot;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-01-16T12:20:07.416Z">
<meta property="article:modified_time" content="2021-01-12T11:11:15.000Z">
<meta property="article:author" content="Dean0731">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>Dean0731&#39;s site</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.dean0731.cn","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Dean0731&#39; Site</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-01-16 20:20" pubdate>
        2022年1月16日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      35k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      292 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            <div class="markdown-body">
              <h1 class="md-end-block md-heading md-focus"><span class="md-plain md-expand">1 多进程</span></h1>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-comment"># 多进程,<br /><span><span class="cm-keyword">import <span class="cm-variable">os<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Process<br /><span><span class="cm-comment"># 启动时必须在 if __name__ 判断下,windows 必须,其他 无限制<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># def func(args):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("子进程:",os.getpid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("子进程的父进程:",os.getppid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(10)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("子进程结束")<br /><span><span class="cm-comment"># if __name__ =="__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Process(target=func,args=(1,))  # 注册 并传入元祖 元祖有一个参数要加逗号<br /><span><span class="cm-comment"># &nbsp; &nbsp; # p是进程对象<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.start() # 开启子进程<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("主进程:", os.getpid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("主进程的父进程:",os.getppid()) # cmd 或者是 pycharm<br /><span><span class="cm-comment"># 生命周期<br /><span><span class="cm-comment"># &nbsp; 主进程长:自己执行完结束<br /><span><span class="cm-comment"># &nbsp; 子进程长:等待子进程结束<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 多进程中的方法<br /><span><span class="cm-comment"># join<br /><span><span class="cm-comment"># def fun(arg1,arg2):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('*'*arg1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; # time.sleep(5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('*'*arg2)<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Process(target=fun,args=(10,20))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; # p.join() # 感知子进程结束<br /><span><span class="cm-comment"># &nbsp; &nbsp; # time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("all is stop")<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("最后的语句")<br /><span><span class="cm-comment"># &nbsp; &nbsp; os.walk(r"目录") # 返回 文件夹中文件名字<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># def fun():<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("xxx")<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p = Process(target=fun)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.join()  # 停止for循环 进程结束后继续<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print("for")<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("主进程")<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 第二种方法<br /><span><span class="cm-comment"># class MyProcess(Process):<br /><span><span class="cm-comment"># &nbsp; &nbsp; def __init__(self,args):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; super().__init__()  # 若要传递参数,需要调用父类init<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># &nbsp; &nbsp; def run(self):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print("子进程",self.__dict__)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print(self.pid)<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("主进程:",os.getpid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1 = MyProcess()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1.start()<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 进程之间数据是隔离,命名空间不通<br /><span><span class="cm-comment"># def fun():<br /><span><span class="cm-comment"># &nbsp; &nbsp; global n<br /><span><span class="cm-comment"># &nbsp; &nbsp; n= 0<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("pid:%s" %os.getpid(),n)<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; n=100<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Process(target=fun)<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.join()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(n) # --&gt;100<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 多进程tcp连接<br /><span><span class="cm-comment"># import socket<br /><span><span class="cm-comment"># # 客户端<br /><span><span class="cm-comment"># sk = socket.socket()<br /><span><span class="cm-comment"># sk.connect(("127.0.0.1",8080))<br /><span><span class="cm-comment"># sk.send('N好'.encode("utf8"))<br /><span><span class="cm-comment"># msg = sk.recv(1024).decode("utf8")<br /><span><span class="cm-comment"># print(msg)<br /><span><span class="cm-comment"># sk.close()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># # 服务端<br /><span><span class="cm-comment"># def server(conn):<br /><span><span class="cm-comment"># &nbsp; &nbsp; ret= "你好".encode("utf8")<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn.send(ret)<br /><span><span class="cm-comment"># &nbsp; &nbsp; msg = conn.recv(1024).decode("utf8")<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(msg)<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn.close()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># sk = socket.socket()<br /><span><span class="cm-comment"># sk.bind(("127.0.0.1",8080))<br /><span><span class="cm-comment"># sk.listen()<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; conn, addr = sk.accept()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p = Process(target=server,args=(conn,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 守护进程<br /><span><span class="cm-comment"># 默认情况 父进程 等待子进程结束<br /><span><span class="cm-comment"># p.daemon = True 在start前,设置为守护进程,守护进程随父进程(代码执行完毕)结束<br /><span><span class="cm-comment"># &nbsp; 若父进程在等待 子进程(非守护进程时) ,若父进程代码完毕,守护进程应该结束<br /><span><span class="cm-comment"># p.is_alive() 判断进程是否存活<br /><span><span class="cm-comment"># p.terminate() 终止进程<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 锁<br /><span><span class="cm-comment"># 未加锁实例:<br /><span><span class="cm-comment"># 火车票<br /><span><span class="cm-keyword">import <span class="cm-variable">json<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Process<br /><span><span class="cm-comment"># def show(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; with open('ticket') as f:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; dic = json.load(f)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('余票: %s'%dic['ticket'])<br /><span><span>​<br /><span><span class="cm-keyword">def <span class="cm-def">buy_ticket(<span class="cm-variable">i):<br /><span> &nbsp; &nbsp;<span class="cm-keyword">with <span class="cm-builtin">open(<span class="cm-string">'ticket') <span class="cm-keyword">as <span class="cm-variable">f:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dic = <span class="cm-variable">json.<span class="cm-property">load(<span class="cm-variable">f)<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-number">0.1)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">if <span class="cm-variable">dic[<span class="cm-string">'ticket'] <span class="cm-operator">&gt; <span class="cm-number">0 :<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dic[<span class="cm-string">'ticket'] -= <span class="cm-number">1<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'\033[32m%s买到票了\033[0m'<span class="cm-operator">%<span class="cm-variable">i)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">else:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'\033[31m%s没买到票\033[0m'<span class="cm-operator">%<span class="cm-variable">i)<br /><span> &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-number">0.1)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">with <span class="cm-builtin">open(<span class="cm-string">'ticket',<span class="cm-string">'w') <span class="cm-keyword">as <span class="cm-variable">f:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json.<span class="cm-property">dump(<span class="cm-variable">dic,<span class="cm-variable">f)<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__ == <span class="cm-string">'__main__':<br /><span> &nbsp; &nbsp;<span class="cm-comment"># for i in range(10):<br /><span> &nbsp; &nbsp;<span class="cm-comment"># &nbsp; &nbsp; p = Process(target=show,args=(i,))<br /><span> &nbsp; &nbsp;<span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-variable">i <span class="cm-keyword">in <span class="cm-builtin">range(<span class="cm-number">10):<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p = <span class="cm-variable">Process(<span class="cm-variable">target=<span class="cm-variable">buy_ticket, <span class="cm-variable">args=(<span class="cm-variable">i))<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">start()<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># 锁<br /><span><span class="cm-comment"># 加锁实例<br /><span><span class="cm-comment"># 火车票<br /><span><span class="cm-keyword">import <span class="cm-variable">json<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Process<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Lock<br /><span><span>​<br /><span><span class="cm-comment"># def show(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; with open('ticket') as f:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; dic = json.load(f)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('余票: %s'%dic['ticket'])<br /><span><span>​<br /><span><span class="cm-keyword">def <span class="cm-def">buy_ticket(<span class="cm-variable">i,<span class="cm-variable">lock):<br /><span> &nbsp; &nbsp;<span class="cm-variable">lock.<span class="cm-property">acquire() <span class="cm-comment">#拿钥匙进门<br /><span> &nbsp; &nbsp;<span class="cm-keyword">with <span class="cm-builtin">open(<span class="cm-string">'ticket') <span class="cm-keyword">as <span class="cm-variable">f:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dic = <span class="cm-variable">json.<span class="cm-property">load(<span class="cm-variable">f)<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-number">0.1)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">if <span class="cm-variable">dic[<span class="cm-string">'ticket'] <span class="cm-operator">&gt; <span class="cm-number">0 :<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dic[<span class="cm-string">'ticket'] -= <span class="cm-number">1<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'\033[32m%s买到票了\033[0m'<span class="cm-operator">%<span class="cm-variable">i)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">else:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'\033[31m%s没买到票\033[0m'<span class="cm-operator">%<span class="cm-variable">i)<br /><span> &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-number">0.1)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">with <span class="cm-builtin">open(<span class="cm-string">'ticket',<span class="cm-string">'w') <span class="cm-keyword">as <span class="cm-variable">f:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">json.<span class="cm-property">dump(<span class="cm-variable">dic,<span class="cm-variable">f)<br /><span> &nbsp; &nbsp;<span class="cm-variable">lock.<span class="cm-property">release() &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 还钥匙<br /><span><span>​<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__ == <span class="cm-string">'__main__':<br /><span> &nbsp; &nbsp;<span class="cm-comment"># for i in range(10):<br /><span> &nbsp; &nbsp;<span class="cm-comment"># &nbsp; &nbsp; p = Process(target=show,args=(i,))<br /><span> &nbsp; &nbsp;<span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span> &nbsp; &nbsp;<span class="cm-variable">lock = <span class="cm-variable">Lock()<br /><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-variable">i <span class="cm-keyword">in <span class="cm-builtin">range(<span class="cm-number">10):<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p = <span class="cm-variable">Process(<span class="cm-variable">target=<span class="cm-variable">buy_ticket, <span class="cm-variable">args=(<span class="cm-variable">i,<span class="cm-variable">lock))<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">start()<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># =================================================<br /><span><span class="cm-comment"># =================================================</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">2 信号量_事件</span></h1>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-comment"># 多进程中的组件<br /><span><span class="cm-comment"># 一个资源 同一时间 被n个人访问<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">import <span class="cm-variable">random<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Process,<span class="cm-variable">Event<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># 未用信号量<br /><span><span class="cm-comment"># def ktv(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s走进ktv'%i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(random.randint(1,5))<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s走出ktv'%i)<br /><span><span class="cm-comment"># if __name__ == '__main__' :<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(20):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p = Process(target=ktv,args=(i))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Semaphore<br /><span><span>​<br /><span><span class="cm-comment"># sem = Semaphore(4)<br /><span><span class="cm-comment"># sem.acquire()<br /><span><span class="cm-comment"># print('拿到第一把钥匙')<br /><span><span class="cm-comment"># sem.acquire()<br /><span><span class="cm-comment"># print('拿到第二把钥匙')<br /><span><span class="cm-comment"># sem.acquire()<br /><span><span class="cm-comment"># print('拿到第三把钥匙')<br /><span><span class="cm-comment"># sem.acquire()<br /><span><span class="cm-comment"># print('拿到第四把钥匙')<br /><span><span class="cm-comment"># sem.acquire()<br /><span><span class="cm-comment"># print('拿到第五把钥匙')<br /><span><span class="cm-comment"># def ktv(i,sem):<br /><span><span class="cm-comment"># &nbsp; &nbsp; sem.acquire() &nbsp;  #获取钥匙<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s走进ktv'%i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(random.randint(1,5))<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s走出ktv'%i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; sem.release() &nbsp;  # 释放钥匙<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__' :<br /><span><span class="cm-comment"># &nbsp; &nbsp; sem = Semaphore(4)<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(20):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p = Process(target=ktv,args=(i,sem))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.start()<br /><span><span>​<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># 事件<br /><span><span class="cm-comment"># &nbsp; 信号是控制进程阻塞与否<br /><span><span class="cm-comment"># &nbsp; 事件创建后,默认是阻塞状态<br /><span><span class="cm-comment"># e = Event() # 创建事件<br /><span><span class="cm-comment"># e.is_set()  # False 默认阻塞<br /><span><span class="cm-comment"># print("xx") # 可打印 e.set() 设置为True e.clear() 设置为False<br /><span><span class="cm-comment"># e.wait()<br /><span><span class="cm-comment"># print("xx") # 阻塞<br /><span><span class="cm-comment"># 遇到wait()会判断is_set() 为False 阻塞<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># 红绿灯事件<br /><span><span class="cm-keyword">def <span class="cm-def">cars(<span class="cm-variable">e,<span class="cm-variable">i):<br /><span> &nbsp; &nbsp;<span class="cm-keyword">if <span class="cm-keyword">not <span class="cm-variable">e.<span class="cm-property">is_set():<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"car%i在等待" <span class="cm-operator">% <span class="cm-variable">i)<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e.<span class="cm-property">wait()<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"car%i通过" <span class="cm-operator">% <span class="cm-variable">i)<br /><span><span>​<br /><span><span>​<br /><span><span class="cm-keyword">def <span class="cm-def">light(<span class="cm-variable">e):<br /><span> &nbsp; &nbsp;<span class="cm-keyword">while <span class="cm-keyword">True:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if <span class="cm-variable">e.<span class="cm-property">is_set():<br /><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e.<span class="cm-property">clear()<br /><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"\033[31m红灯\033[0m")<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e.<span class="cm-property">set()<br /><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">"\033[32m绿灯\033[0m")<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-number">2)<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__ == <span class="cm-string">"__main__":<br /><span> &nbsp; &nbsp;<span class="cm-variable">e = <span class="cm-variable">Event()<br /><span> &nbsp; &nbsp;<span class="cm-variable">p =<span class="cm-variable">Process(<span class="cm-variable">target=<span class="cm-variable">light,<span class="cm-variable">args=(<span class="cm-variable">e,))<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">start()<br /><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-variable">i <span class="cm-keyword">in <span class="cm-builtin">range(<span class="cm-number">1,<span class="cm-number">21):<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">car = <span class="cm-variable">Process(<span class="cm-variable">target=<span class="cm-variable">cars,<span class="cm-variable">args=(<span class="cm-variable">e,<span class="cm-variable">i))<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">car.<span class="cm-property">start()<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-variable">random.<span class="cm-property">random())<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># ==============================<br /><span><span class="cm-comment"># def test(e):<br /><span><span class="cm-comment"># &nbsp; &nbsp; e.set()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("xxx")<br /><span><span class="cm-comment"># if __name__=="__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; e = Event()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(e.is_set())<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Process(target=test,args=(e,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; e.wait()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("注")<br /><span><span>​</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">3 进程通信_队列管道</span></h1>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-comment"># IPC 内部进程通信,不能使用普通queue<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Queue,<span class="cm-variable">Process<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-comment"># q = Queue(5)  # 队列大小<br /><span><span class="cm-comment"># q.put(1)<br /><span><span class="cm-comment"># q.put(1)<br /><span><span class="cm-comment"># q.full()  # 若队列满了,阻塞等待<br /><span><span class="cm-comment"># q.get()<br /><span><span class="cm-comment"># q.empty()  # 若为空,阻塞等待有数据 后取值<br /><span><span class="cm-comment"># q.get()<br /><span><span class="cm-comment"># q.get_nowait()  # 用于跳过等待,需要用try<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-comment"># def produce(q):<br /><span><span class="cm-comment"># &nbsp; &nbsp; q.put('hello')<br /><span><span class="cm-comment"># def consume(q):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(q.get())<br /><span><span class="cm-comment"># if __name__ =="__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; q = Queue()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Process(target=produce,args=(q,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p2 = Process(target=consume, args=(q,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p2.start()<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-comment"># 生产者消费者模型<br /><span><span class="cm-comment"># 若生产者,生产有数量,消费者,不停消费,最后消费进程会处于等待状态<br /><span><span class="cm-comment"># 可在主进程后边join生产进程,消费进程判断为空,但不准确<br /><span><span class="cm-comment"># &nbsp; 需要在队列put(None) 子进程判断,由于数据之间不能共享,需要put 消费数量的None<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">JoinableQueue<br /><span><span class="cm-comment"># consume :<br /><span><span class="cm-comment"># &nbsp; &nbsp; ....<br /><span><span class="cm-comment"># &nbsp; &nbsp; q.task_done()<br /><span><span class="cm-comment"># produce :<br /><span><span class="cm-comment"># &nbsp; &nbsp; ...<br /><span><span class="cm-comment"># &nbsp; &nbsp; q.join()<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-comment">#  循环通知,致使进程结束<br /><span><span class="cm-comment"># JoinableQueue<br /><span><span class="cm-comment"># 生产者生产,不停不停消费,若q为空 一直等待,<br /><span><span class="cm-comment"># &nbsp; 生产者完毕后,会join等待消费值消费完毕,因为是同一个q,一个生产者完毕后,其他还没有完毕q会处于,他会处于阻塞<br /><span><span class="cm-comment"># &nbsp; 等待 消费者 全部消费完毕,q.join()会感知,因此 生产进程会结束,主进程最后join生产进程,生产结束<br /><span><span class="cm-comment"># &nbsp; 主进程就结束,身为守护进程的子进程也结束<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># import random<br /><span><span class="cm-comment"># from multiprocessing import Process,JoinableQueue<br /><span><span class="cm-comment"># def consumer(q,name):<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; food = q.get()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print('\033[31m%s消费了%s\033[0m' % (name,food))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; time.sleep(random.randint(1,3))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; q.task_done() &nbsp; &nbsp; # count - 1<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def producer(name,food,q):<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(4):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; time.sleep(random.randint(1,3))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; f = '%s生产了%s%s'%(name,food,i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print(f)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; q.put(f)<br /><span><span class="cm-comment"># &nbsp; &nbsp; q.join() &nbsp;  # 阻塞  直到一个队列中的所有数据 全部被处理完毕<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__  == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; q = JoinableQueue(20)<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1 = Process(target=producer,args=('Egon','包子',q))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p2 = Process(target=producer, args=('wusir','泔水', q))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1 = Process(target=consumer, args=(q,'alex'))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2 = Process(target=consumer, args=(q,'jinboss'))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p2.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1.daemon = True &nbsp; # 设置为守护进程 主进程中的代码执行完毕之后,子进程自动结束<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2.daemon = True<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1.join()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p2.join() &nbsp; &nbsp;  # 感知一个进程的结束<br /><span><span>​<br /><span><span class="cm-comment">#  在消费者这一端:<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 每次获取一个数据<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 处理一个数据<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 发送一个记号 : 标志一个数据被处理成功<br /><span><span>​<br /><span><span class="cm-comment"># 在生产者这一端:<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 每一次生产一个数据,<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 且每一次生产的数据都放在队列中<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 在队列中刻上一个记号<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 当生产者全部生产完毕之后,<br /><span> &nbsp; &nbsp;<span class="cm-comment"># join信号 : 已经停止生产数据了<br /><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 且要等待之前被刻上的记号都被消费完<br /><span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 当数据都被处理完时,join阻塞结束<br /><span><span>​<br /><span><span class="cm-comment"># consumer 中把所有的任务消耗完<br /><span><span class="cm-comment"># producer 端 的 join感知到,停止阻塞<br /><span><span class="cm-comment"># 所有的producer进程结束<br /><span><span class="cm-comment"># 主进程中的p.join结束<br /><span><span class="cm-comment"># 主进程中代码结束<br /><span><span class="cm-comment"># 守护进程(消费者的进程)结束<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-comment"># 管道 双向通信工具<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Pipe<br /><span><span class="cm-comment"># conn,conn2 = Pipe()<br /><span><span class="cm-comment"># conn.send("123456")  # 不用字节<br /><span><span class="cm-comment"># print(conn2.recv())  # 不用指定大小<br /><span><span>​<br /><span><span class="cm-keyword">def <span class="cm-def">fun(<span class="cm-variable">conn):<br /><span> &nbsp; &nbsp;<span class="cm-variable">conn.<span class="cm-property">send(<span class="cm-string">"hello")<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__==<span class="cm-string">"__main__":<br /><span> &nbsp; &nbsp;<span class="cm-variable">conn1,<span class="cm-variable">conn2  = <span class="cm-variable">Pipe()<br /><span> &nbsp; &nbsp;<span class="cm-variable">Process(<span class="cm-variable">target=<span class="cm-variable">fun,<span class="cm-variable">args=(<span class="cm-variable">conn1,)).<span class="cm-property">start()<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-variable">conn1.<span class="cm-property">recv())<br /><span><span class="cm-comment"># 管道返回2个连接<br /><span><span class="cm-comment"># &nbsp;  conn1, conn2<br /><span><span class="cm-comment"># P &nbsp;  发送 接受<br /><span><span class="cm-comment"># p2 &nbsp; 接受 发送<br /><span><span class="cm-comment"># 若只发数据,可关闭一端,若取数据的时候,对面已关闭,则报错,看根据此 终止程序<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Pipe,<span class="cm-variable">Process<br /><span><span class="cm-comment"># def func(conn1,conn2):<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn2.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; try :<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; msg = conn1.recv()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(msg)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; except EOFError:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conn1.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn1, conn2 = Pipe()<br /><span><span class="cm-comment"># &nbsp; &nbsp; Process(target=func,args = (conn1,conn2)).start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn1.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(20):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; conn2.send('吃了么')<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn2.close()<br /><span><span class="cm-comment"># ===============================<br /><span><span class="cm-comment"># from multiprocessing import Lock,Pipe,Process<br /><span><span class="cm-comment"># def producer(con,pro,name,food):<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(100):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; f = '%s生产%s%s'%(name,food,i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print(f)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; pro.send(f)<br /><span><span class="cm-comment"># &nbsp; &nbsp; pro.send(None)<br /><span><span class="cm-comment"># &nbsp; &nbsp; pro.send(None)<br /><span><span class="cm-comment"># &nbsp; &nbsp; pro.send(None)<br /><span><span class="cm-comment"># &nbsp; &nbsp; pro.close()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def consumer(con,pro,name,lock):<br /><span><span class="cm-comment"># &nbsp; &nbsp; pro.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lock.acquire()  # 不安全主要是recv的时候,因此两端加锁即可<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; food = con.recv()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lock.release()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if food is None:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; con.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print('%s吃了%s' % (name, food))<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; con,pro = Pipe()<br /><span><span class="cm-comment"># &nbsp; &nbsp; lock= Lock()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Process(target=producer,args=(con,pro,'egon','泔水'))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1 = Process(target=consumer, args=(con, pro, 'alex',lock))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2 = Process(target=consumer, args=(con, pro, 'bossjin',lock))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c3 = Process(target=consumer, args=(con, pro, 'wusir',lock))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; c3.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; pro.close()<br /><span><span>​<br /><span><span class="cm-comment"># from multiprocessing import Process,Pipe,Lock<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def consumer(produce, consume,name,lock):<br /><span><span class="cm-comment"># &nbsp; &nbsp; produce.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; baozi=consume.recv()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; lock.release()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; if baozi:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print('%s 收到包子:%s' %(name,baozi))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; else:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; consume.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def producer(produce, consume,n):<br /><span><span class="cm-comment"># &nbsp; &nbsp; consume.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(n):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; produce.send(i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; produce.send(None)<br /><span><span class="cm-comment"># &nbsp; &nbsp; produce.send(None)<br /><span><span class="cm-comment"># &nbsp; &nbsp; produce.close()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; produce,consume=Pipe()<br /><span><span class="cm-comment"># &nbsp; &nbsp; lock = Lock()<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1=Process(target=consumer,args=(produce,consume,'c1',lock))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2=Process(target=consumer,args=(produce,consume,'c2',lock))<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1=Process(target=producer,args=(produce,consume,30))<br /><span><span class="cm-comment"># &nbsp; &nbsp; c1.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; c2.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; p1.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; produce.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; consume.close()<br /><span><span>​<br /><span><span class="cm-comment"># pipe 数据不安全性<br /><span><span class="cm-comment"># IPC<br /><span><span class="cm-comment"># 加锁来控制操作管道的行为 来避免进程之间争抢数据造成的数据不安全现象<br /><span><span>​<br /><span><span class="cm-comment"># 队列 进程之间数据安全的<br /><span><span class="cm-comment"># &nbsp; 管道 + 锁</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">3_进程通信__数据共享</span></h1>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Manager,<span class="cm-variable">Process,<span class="cm-variable">Lock<br /><span><span class="cm-comment"># 进程之间不能传递数据,通过方法的参数可以传过去,但修改后,无反应,不知道原因<br /><span><span class="cm-keyword">def <span class="cm-def">main(<span class="cm-builtin">dict,<span class="cm-variable">lock):<br /><span> &nbsp; &nbsp;<span class="cm-variable">lock.<span class="cm-property">acquire()<br /><span> &nbsp; &nbsp;<span class="cm-builtin">dict[<span class="cm-string">'count']-=<span class="cm-number">1<br /><span> &nbsp; &nbsp;<span class="cm-variable">lock.<span class="cm-property">release()<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__ == <span class="cm-string">"__main__":<br /><span> &nbsp; &nbsp;<span class="cm-variable">m = <span class="cm-variable">Manager()<br /><span> &nbsp; &nbsp;<span class="cm-variable">l = <span class="cm-variable">Lock()<br /><span> &nbsp; &nbsp;<span class="cm-builtin">dict = <span class="cm-variable">m.<span class="cm-property">dict({<span class="cm-string">"count":<span class="cm-number">100})<br /><span> &nbsp; &nbsp;<span class="cm-variable">p_list=[]<br /><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-variable">i <span class="cm-keyword">in <span class="cm-builtin">range(<span class="cm-number">50):<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p = <span class="cm-variable">Process(<span class="cm-variable">target=<span class="cm-variable">main,<span class="cm-variable">args=(<span class="cm-builtin">dict,<span class="cm-variable">l))<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">start()<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p_list.<span class="cm-property">append(<span class="cm-variable">p)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-variable">i <span class="cm-keyword">in <span class="cm-variable">p_list:<span class="cm-variable">i.<span class="cm-property">join()<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-builtin">dict[<span class="cm-string">'count'])</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">4_进程池</span></h1>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-comment"># 进程池<br /><span><span class="cm-comment"># 上一个例子中50个进程很慢<br /><span><span class="cm-comment"># &nbsp; 寄存器 堆栈 文件<br /><span><span class="cm-comment"># &nbsp; 操作系统调度,cup切换<br /><span><span class="cm-comment"># 高级线程池有数量限定 ,有最低,任务变多的时候 逐步加到最高限制<br /><span><span class="cm-keyword">import <span class="cm-variable">os,<span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Pool,<span class="cm-variable">Manager<br /><span><span class="cm-comment"># ==================================<br /><span><span class="cm-comment"># def func2(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(os.getpid(),os.getppid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; i+1<br /><span><span class="cm-comment"># def func(list):<br /><span><span class="cm-comment"># &nbsp; &nbsp; list[1]['set'].add(os.getpid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(len(list[1]['set']))<br /><span><span class="cm-comment"># # 一般超过5个使用pool<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; pid = Manager()<br /><span><span class="cm-comment"># &nbsp; &nbsp; dict1 = pid.dict({"set":set()})<br /><span><span class="cm-comment"># &nbsp; &nbsp; pool = Pool(5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; # 执行不同的任务,map 自带join方法<br /><span><span class="cm-comment"># &nbsp; &nbsp; #pool.map(func2,range(100))<br /><span><span class="cm-comment"># &nbsp; &nbsp; pool.map(func, [[i,dict1]for i in range(100)])<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(len(dict1['set']))<br /><span><span class="cm-comment"># """<br /><span><span class="cm-comment"># 等于<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(100):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p = Process(target=func,args=(i,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.start()<br /><span><span class="cm-comment"># """<br /><span><span class="cm-comment"># ==================================<br /><span><span class="cm-comment"># def fun(n):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("start fun%s" %n,os.getpid())<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print("end fun%s" % n, os.getpid())<br /><span><span class="cm-comment"># if __name__ == "__main__":<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Pool() # 默认cup核心数量<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; #p.apply(fun,args=(i,)) # 同步提交的<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.apply_async(fun,args=(i,)) # 异步提交,真的异步,因此需要join<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.close()  # 不再接受新的任务<br /><span><span class="cm-comment"># &nbsp; &nbsp; p.join()  # 感知进程池中任务结束 保持 主进程 与子进程同步<br /><span><span>​<br /><span><span class="cm-comment"># ==================================<br /><span><span class="cm-comment"># import socket<br /><span><span class="cm-comment"># from multiprocessing import Pool<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def func(conn):<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn.send(b'hello')<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(conn.recv(1024).decode('utf-8'))<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn.close()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Pool(5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk = socket.socket()<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk.bind(('127.0.0.1',8080))<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk.listen()<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; conn, addr = sk.accept()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; p.apply_async(func,args=(conn,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk.close()<br /><span><span class="cm-comment"># &nbsp; &nbsp; import socket<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk = socket.socket()<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk.connect(('127.0.0.1', 8080))<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># &nbsp; &nbsp; ret = sk.recv(1024).decode('utf-8')<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(ret)<br /><span><span class="cm-comment"># &nbsp; &nbsp; msg = input('&gt;&gt;&gt;').encode('utf-8')<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk.send(msg)<br /><span><span class="cm-comment"># &nbsp; &nbsp; sk.close()<br /><span><span class="cm-comment"># ==================================<br /><span><span class="cm-comment"># 进程池的返回值<br /><span><span class="cm-comment"># p = Pool()<br /><span><span class="cm-comment"># p.map(funcname,iterable) &nbsp; &nbsp; 默认异步的执行任务,且自带close和join<br /><span><span class="cm-comment"># p.apply &nbsp; 同步调用的<br /><span><span class="cm-comment"># p.apply_async 异步调用 和主进程完全异步 需要手动close 和 join<br /><span><span class="cm-comment"># from multiprocessing import Pool<br /><span><span class="cm-comment"># def func(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; return i*i<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Pool(5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; res = p.apply(func,args=(i,)) &nbsp; # apply的结果就是func的返回值<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print(res) --&gt; 直接就是返回值<br /><span><span class="cm-comment"># ==================================<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># from multiprocessing import Pool<br /><span><span class="cm-comment"># def func(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(0.5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; return i*i<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Pool(5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; res_l = []<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; res = p.apply_async(func,args=(i,)) &nbsp; # apply的结果就是func的返回值<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; res_l.append(res)<br /><span><span class="cm-comment"># &nbsp; 若在for 中直接获取res.get()会在成阻塞,程序变同步执行<br /><span><span class="cm-comment"># &nbsp; &nbsp; for res in res_l:print(res.get())# 等着 func的计算结果<br /><span><span class="cm-comment"># &nbsp;  调用res.get时返回<br /><span><span class="cm-comment"># ==================================<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># from multiprocessing import Pool<br /><span><span class="cm-comment"># def func(i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(0.5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; return i*i<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; p = Pool(5)<br /><span><span class="cm-comment"># &nbsp; &nbsp; ret = p.map(func,range(100))<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(ret)  #  -&gt; 直接返回全部,列表返回<br /><span><span class="cm-comment"># 自带join,close 最后一起返回<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment"># 回调函数 , 回调的函数在主进程调用<br /><span><span class="cm-comment"># 对于子进程中再起子进程问题,还不知道<br /><span><span class="cm-comment"># 每个进程的回调函数 交给主进程顺序执行<br /><span><span class="cm-keyword">import <span class="cm-variable">os<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Pool,<span class="cm-variable">Process<br /><span><span class="cm-keyword">def <span class="cm-def">func2(<span class="cm-variable">nn):<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'in func2',<span class="cm-variable">os.<span class="cm-property">getpid())<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-variable">nn)<br /><span><span class="cm-keyword">def <span class="cm-def">func3(<span class="cm-variable">n):<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'in func3', <span class="cm-variable">os.<span class="cm-property">getpid())<br /><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">n<span class="cm-operator">*<span class="cm-variable">n<br /><span><span class="cm-keyword">def <span class="cm-def">func1(<span class="cm-variable">n):<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'in func1',<span class="cm-variable">os.<span class="cm-property">getpid())<br /><span> &nbsp; &nbsp;<span class="cm-variable">p = <span class="cm-variable">Pool(<span class="cm-number">5)<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">apply_async(<span class="cm-variable">func3, <span class="cm-variable">args=(<span class="cm-number">10,), <span class="cm-variable">callback=<span class="cm-variable">func2)<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">close()<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">join()<br /><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">n<span class="cm-operator">*<span class="cm-variable">n<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__ == <span class="cm-string">'__main__':<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'主进程 :',<span class="cm-variable">os.<span class="cm-property">getpid())<br /><span> &nbsp; &nbsp;<span class="cm-variable">p = <span class="cm-variable">Pool(<span class="cm-number">5)<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">apply_async(<span class="cm-variable">func1,<span class="cm-variable">args=(<span class="cm-number">10,),<span class="cm-variable">callback=<span class="cm-variable">func2)<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">close()<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">join()<br /><span><span class="cm-comment"># ===================================================<br /><span><span class="cm-keyword">import <span class="cm-variable">requests<br /><span><span class="cm-keyword">from <span class="cm-variable">urllib.<span class="cm-property">request <span class="cm-keyword">import <span class="cm-variable">urlopen<br /><span><span class="cm-keyword">from <span class="cm-variable">multiprocessing <span class="cm-keyword">import <span class="cm-variable">Pool<br /><span><span class="cm-comment"># 200 网页正常的返回<br /><span><span class="cm-comment"># 404 网页找不到<br /><span><span class="cm-comment"># 502 504<br /><span><span class="cm-comment"># 场景:callback 耗时段,远小于网络延时,此时使用,在主进程运行,<br /><span><span class="cm-keyword">def <span class="cm-def">get(<span class="cm-variable">url):<br /><span> &nbsp; &nbsp;<span class="cm-variable">response = <span class="cm-variable">requests.<span class="cm-property">get(<span class="cm-variable">url)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">if <span class="cm-variable">response.<span class="cm-property">status_code == <span class="cm-number">200:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">url, <span class="cm-variable">response.<span class="cm-property">content.<span class="cm-property">decode(<span class="cm-string">'utf-8')<br /><span><span>​<br /><span><span>​<br /><span><span class="cm-keyword">def <span class="cm-def">get_urllib(<span class="cm-variable">url):<br /><span> &nbsp; &nbsp;<span class="cm-variable">ret = <span class="cm-variable">urlopen(<span class="cm-variable">url)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">ret.<span class="cm-property">read().<span class="cm-property">decode(<span class="cm-string">'utf-8')<br /><span><span>​<br /><span><span>​<br /><span><span class="cm-keyword">def <span class="cm-def">call_back(<span class="cm-variable">args):<br /><span> &nbsp; &nbsp;<span class="cm-variable">url, <span class="cm-variable">content = <span class="cm-variable">args<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-variable">url, <span class="cm-builtin">len(<span class="cm-variable">content))<br /><span><span>​<br /><span><span>​<br /><span><span class="cm-keyword">if <span class="cm-variable">__name__ == <span class="cm-string">'__main__':<br /><span> &nbsp; &nbsp;<span class="cm-variable">url_lst = [<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'https://www.cnblogs.com/',<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'http://www.baidu.com',<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'https://www.sogou.com/',<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'http://www.sohu.com/',<br /><span> &nbsp;  ]<br /><span> &nbsp; &nbsp;<span class="cm-variable">p = <span class="cm-variable">Pool(<span class="cm-number">5)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">for <span class="cm-variable">url <span class="cm-keyword">in <span class="cm-variable">url_lst:<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">apply_async(<span class="cm-variable">get, <span class="cm-variable">args=(<span class="cm-variable">url,), <span class="cm-variable">callback=<span class="cm-variable">call_back) <span class="cm-comment"># callback 中的参数为 get函数的返回值<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">close()<br /><span> &nbsp; &nbsp;<span class="cm-variable">p.<span class="cm-property">join()</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">4_线程</span></h1>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h4 class="md-end-block md-heading"><span class="md-plain">两者之间应该有对应关系1:1 1:n</span></h4>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<h3 class="md-end-block md-heading"><span class="md-plain">linux 中的nptl 1对1 线程</span></h3>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-comment"># 同一进程的线程间的数据共享的,共享的 共享的<br /><span><span class="cm-comment"># &nbsp; 可通过直接访问全局变量 global,还需要进程同步<br /><span><span class="cm-comment"># &nbsp; 创建,切换,撤销 相比进程 消耗小,轻量级<br /><span><span class="cm-comment"># &nbsp; 进程:资源分配单位,每个进程 至少一个线程<br /><span><span class="cm-comment"># &nbsp; 线程:cup调度单位<br /><span><span class="cm-comment"># thread 基本模块,避免使用,可能与threading 冲突<br /><span><span class="cm-comment"># threading thread的高级版本<br /><span><span class="cm-comment"># Queue 多线程之间共享数据的数据结构<br /><span><span class="cm-comment"># 与进程类似,好多方法相同<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">threading <span class="cm-keyword">import <span class="cm-variable">Thread<br /><span><span class="cm-keyword">import <span class="cm-variable">threading<br /><span><span class="cm-comment"># def func(n):<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(n)<br /><span><span class="cm-comment"># t = Thread(target=func,args=(12,))<br /><span><span class="cm-comment"># t.daemon = True # 成为"守护线程"<br /><span><span class="cm-comment"># t.start()<br /><span><span class="cm-comment"># print("主线程") # 默认情况等待子线程结束<br /><span><span class="cm-comment"># ===================================<br /><span><span class="cm-comment"># class MyThread(Thread):<br /><span><span class="cm-comment"># &nbsp; &nbsp; def __init__(self,name):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; super().__init__()<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; self.name = name<br /><span><span class="cm-comment"># &nbsp; &nbsp; def run(self):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; # time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print(self.name)<br /><span><span class="cm-comment"># MyThread("thread1").start()<br /><span><span class="cm-comment"># ================================<br /><span><span class="cm-comment"># GIL 锁的是线程,同一时间 只有一个线程 ,cpython解释器的问题,jpython 就不会<br /><span><span class="cm-comment"># 对于io密集型 没什么区别,只要io时会切换即可<br /><span><span class="cm-comment"># 但对于多核cup python 同时只能运行一个cup ,其他语言的会运行多个,因此...<br /><span><span class="cm-comment"># 即不能通过物理核心数增加速度,不能实现(并行)<br /><span><span class="cm-comment"># ============================================<br /><span><span class="cm-comment"># 多线程socket 可以input<br /><span><span class="cm-comment"># import socket<br /><span><span class="cm-comment"># from threading import Thread<br /><span><span class="cm-comment"># def chat(conn):<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn.send(b'hello')<br /><span><span class="cm-comment"># &nbsp; &nbsp; msg = conn.recv(1024).decode('utf-8')<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(msg)<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn.close()<br /><span><span class="cm-comment"># sk = socket.socket()<br /><span><span class="cm-comment"># sk.bind(('127.0.0.1',8080))<br /><span><span class="cm-comment"># sk.listen()<br /><span><span class="cm-comment"># while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; conn,addr = sk.accept()<br /><span><span class="cm-comment"># &nbsp; &nbsp; Thread(target=chat,args = (conn,)).start()<br /><span><span class="cm-comment"># sk.close()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># import socket<br /><span><span class="cm-comment"># sk = socket.socket()<br /><span><span class="cm-comment"># sk.connect(('127.0.0.1',8080))<br /><span><span class="cm-comment"># msg = sk.recv(1024)<br /><span><span class="cm-comment"># print(msg)<br /><span><span class="cm-comment"># inp = input('&gt;&gt;&gt; ').encode('utf-8')<br /><span><span class="cm-comment"># sk.send(inp)<br /><span><span class="cm-comment"># sk.close()<br /><span><span class="cm-comment"># =========================<br /><span><span class="cm-comment"># print(threading.current_thread()) # 当前线程<br /><span><span class="cm-comment"># print(threading.active_count()) # 全部线程,包括主线程<br /><span><span class="cm-comment"># print(threading.enumerate())  # 列表返回全部线程对象<br /><span><span class="cm-comment"># ==========================================<br /><span><span class="cm-comment"># 守护线程<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># from threading import Thread<br /><span><span class="cm-comment"># def func1():<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print('*'*10)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># def func2():<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('in func2')<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(5)<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># t = Thread(target=func1,)<br /><span><span class="cm-comment"># t.daemon = True<br /><span><span class="cm-comment"># t.start()<br /><span><span class="cm-comment"># t2 = Thread(target=func2,)<br /><span><span class="cm-comment"># t2.start()<br /><span><span class="cm-comment"># t2.join()<br /><span><span class="cm-comment"># print('主线程')<br /><span><span>​<br /><span><span class="cm-comment"># (守护进程)随着(主进程代码)的执行结束而结束<br /><span><span class="cm-comment"># 守护(线程)会在主线程结束之后等待(其他非守护子线程)的结束才结束<br /><span><span>​<br /><span><span class="cm-comment"># 主进程在执行完自己的代码之后不会立即结束 而是等待子进程结束之后 回收子进程的资源<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># from multiprocessing import Process<br /><span><span class="cm-comment"># def func():<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(5)<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># if __name__ == '__main__':<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; Process(target=func).start()<br /><span><span class="cm-comment"># =========================================<br /><span><span class="cm-comment"># 线程锁 ,与gil无关<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">threading <span class="cm-keyword">import <span class="cm-variable">Lock,<span class="cm-variable">Thread<br /><span><span class="cm-comment"># Lock 互斥锁<br /><span><span class="cm-comment"># def func(lock):<br /><span><span class="cm-comment"># &nbsp; &nbsp; global n<br /><span><span class="cm-comment"># &nbsp; &nbsp; lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; temp = n<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(0.2)<br /><span><span class="cm-comment"># &nbsp; &nbsp; n = temp - 1<br /><span><span class="cm-comment"># &nbsp; &nbsp; lock.release()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># n = 10<br /><span><span class="cm-comment"># t_lst = []<br /><span><span class="cm-comment"># lock = Lock()<br /><span><span class="cm-comment"># for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; t = Thread(target=func,args=(lock,))<br /><span><span class="cm-comment"># &nbsp; &nbsp; t.start()<br /><span><span class="cm-comment"># &nbsp; &nbsp; t_lst.append(t)<br /><span><span>​<br /><span><span class="cm-comment"># for t in  t_lst: t.join()<br /><span><span class="cm-comment"># print(n)<br /><span><span>​<br /><span><span class="cm-comment"># 科学家吃面 &nbsp; 还会死锁<br /><span><span>​<br /><span><span class="cm-comment"># noodle_lock  = Lock()<br /><span><span class="cm-comment"># fork_lock = Lock()<br /><span><span class="cm-comment"># def eat1(name):<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到面条啦'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到叉子了'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s吃面'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.release()<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.release()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def eat2(name):<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到叉子了'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到面条啦'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s吃面'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.release()<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.release()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># Thread(target=eat1,args=('alex',)).start()<br /><span><span class="cm-comment"># Thread(target=eat2,args=('Egon',)).start()<br /><span><span class="cm-comment"># Thread(target=eat1,args=('bossjin',)).start()<br /><span><span class="cm-comment"># Thread(target=eat2,args=('nezha',)).start()<br /><span><span class="cm-comment"># ===============================================<br /><span><span class="cm-keyword">from <span class="cm-variable">threading <span class="cm-keyword">import <span class="cm-variable">RLock &nbsp; <span class="cm-comment"># 递归锁<br /><span><span class="cm-variable">fork_lock = <span class="cm-variable">noodle_lock  = <span class="cm-variable">RLock()<br /><span><span class="cm-comment"># 一个钥匙串上的两把钥匙,同一个lock 在一个线程中可又多次acquire<br /><span><span class="cm-comment"># 传给其他线程时 不能被acquire<br /><span><span class="cm-comment"># def eat1(name):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.acquire() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  # 一把钥匙<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到面条啦'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到叉子了'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s吃面'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.release()<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.release()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def eat2(name):<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到叉子了'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s拿到面条啦'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('%s吃面'%name)<br /><span><span class="cm-comment"># &nbsp; &nbsp; noodle_lock.release()<br /><span><span class="cm-comment"># &nbsp; &nbsp; fork_lock.release()<br /><span><span class="cm-comment"># Thread(target=eat1,args=('alex',)).start()<br /><span><span class="cm-comment"># Thread(target=eat2,args=('Egon',)).start()<br /><span><span class="cm-comment"># Thread(target=eat1,args=('bossjin',)).start()<br /><span><span class="cm-comment"># Thread(target=eat2,args=('nezha',)).start()<br /><span><span class="cm-comment"># =================================================</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">5<span>_<span class="md-plain">线程<span>_<span class="md-plain">信号量<span>_<span class="md-plain">事件<span>_<span class="md-plain">条件<span>_<span class="md-plain">定时器<span>_<span class="md-plain">列队<span>_<span class="md-plain">线程池</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></h1>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-keyword">from <span class="cm-variable">threading <span class="cm-keyword">import <span class="cm-variable">Semaphore,<span class="cm-variable">Thread<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment"># def func(sem,a,b):<br /><span><span class="cm-comment"># &nbsp; &nbsp; sem.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(a+b)<br /><span><span class="cm-comment"># &nbsp; &nbsp; sem.release()<br /><span><span class="cm-comment"># sem = Semaphore(4)<br /><span><span class="cm-comment"># for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; t = Thread(target=func,args=(sem,i,i+5))<br /><span><span class="cm-comment"># &nbsp; &nbsp; t.start()<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment"># 事件被创建的时候<br /><span><span class="cm-comment"># False状态<br /><span> &nbsp; &nbsp;<span class="cm-comment"># wait() 阻塞<br /><span><span class="cm-comment"># True状态<br /><span> &nbsp; &nbsp;<span class="cm-comment"># wait() 非阻塞<br /><span><span class="cm-comment"># clear 设置状态为False<br /><span><span class="cm-comment"># set  设置状态为True<br /><span><span class="cm-comment">#  数据库 - 文件夹<br /><span><span class="cm-comment">#  文件夹里有好多excel表格<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 1.能够更方便的对数据进行增删改查<br /><span> &nbsp; &nbsp;<span class="cm-comment"># 2.安全访问的机制<br /><span><span class="cm-comment">#  起两个线程<br /><span><span class="cm-comment">#  第一个线程 : 连接数据库<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 等待一个信号 告诉我我们之间的网络是通的<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 连接数据库<br /><span><span class="cm-comment">#  第二个线程 : 检测与数据库之间的网络是否连通<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># time.sleep(0,2) 2<br /><span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 将事件的状态设置为True<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># import random<br /><span><span class="cm-comment"># from threading import Thread,Event<br /><span><span class="cm-comment"># def connect_db(e):<br /><span><span class="cm-comment"># &nbsp; &nbsp; count = 0<br /><span><span class="cm-comment"># &nbsp; &nbsp; while count &lt; 3:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; e.wait(0.5) &nbsp; # 状态为False的时候,我只等待1s就结束<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; if e.is_set() == True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print('连接数据库')<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; else:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count += 1<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print('第%s次连接失败'%count)<br /><span><span class="cm-comment"># &nbsp; &nbsp; else:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; raise TimeoutError('数据库连接超时')<br /><span><span class="cm-comment"># def check_web(e):<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(random.randint(0,3))<br /><span><span class="cm-comment"># &nbsp; &nbsp; e.set()<br /><span><span class="cm-comment"># e = Event()<br /><span><span class="cm-comment"># t1 = Thread(target=connect_db,args=(e,))<br /><span><span class="cm-comment"># t2 = Thread(target=check_web,args=(e,))<br /><span><span class="cm-comment"># t1.start()<br /><span><span class="cm-comment"># t2.start()<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment"># 条件 复杂的锁<br /><span><span class="cm-comment"># 条件<br /><span><span class="cm-keyword">from <span class="cm-variable">threading <span class="cm-keyword">import <span class="cm-variable">Condition<br /><span><span class="cm-comment"># 条件<br /><span><span class="cm-comment"># 锁<br /><span><span class="cm-comment"># acquire release<br /><span><span class="cm-comment"># 一个条件被创建之初 默认有一个(False)状态<br /><span><span class="cm-comment"># False状态 会影响wait一直处于等待状态<br /><span><span class="cm-comment"># notify(int数据类型)  造钥匙<br /><span><span class="cm-comment"># from threading import Thread,Condition<br /><span><span class="cm-comment"># def func(con,i):<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.wait() # 等钥匙<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('在第%s个循环里'%i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.release()<br /><span><span class="cm-comment"># con = Condition()<br /><span><span class="cm-comment"># for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; Thread(target=func,args = (con,i)).start()<br /><span><span class="cm-comment"># while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; num = int(input('&gt;&gt;&gt;'))<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.acquire()<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.notify(num)  # 造钥匙<br /><span><span class="cm-comment"># &nbsp; &nbsp; con.release()<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment">#定时器<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># from threading import Timer<br /><span><span class="cm-comment"># def func():<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('时间同步') &nbsp; #1-3<br /><span><span class="cm-comment"># while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; t = Timer(5,func).start() &nbsp; # 非阻塞的 ,异步的 ,会把所有的5s在一起<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(5) # 睡5s 每5s进行意思时间同步<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment"># 加锁 麻烦 所以使用队列<br /><span><span class="cm-comment">#线程通信<br /><span><span class="cm-comment"># queue<br /><span><span class="cm-comment"># import queue #直接导入普通queue 是线程安全的<br /><span><span class="cm-comment"># q = queue.Queue()  # 队列 先进先出<br /><span><span class="cm-comment"># q.put()<br /><span><span class="cm-comment"># q.get()<br /><span><span class="cm-comment"># q.put_nowait()<br /><span><span class="cm-comment"># q.get_nowait()<br /><span><span class="cm-comment"># q = queue.LifoQueue()  # 栈 先进后出<br /><span><span class="cm-comment"># q.put(1)<br /><span><span class="cm-comment"># q.put(2)<br /><span><span class="cm-comment"># q.put(3)<br /><span><span class="cm-comment"># print(q.get())<br /><span><span class="cm-comment"># print(q.get())<br /><span><span class="cm-comment"># q = queue.PriorityQueue()  # 优先级队列<br /><span><span class="cm-comment"># q.put((1,'a'))<br /><span><span class="cm-comment"># q.put((10,'b'))<br /><span><span class="cm-comment"># q.put((30,'c'))<br /><span><span class="cm-comment"># q.put((1,'d'))<br /><span><span class="cm-comment"># q.put((1,'f'))<br /><span><span class="cm-comment"># print(q.get())<br /><span><span class="cm-comment"># 元祖中的元素按顺序比较,数字越小优先级大,祖父按照ascii越小优先级越大<br /><span><span class="cm-comment"># ====================================<br /><span><span class="cm-comment"># 线程池<br /><span><span class="cm-keyword">import <span class="cm-variable">time<br /><span><span class="cm-comment"># 以前没有线程池<br /><span><span class="cm-keyword">from <span class="cm-variable">concurrent.<span class="cm-property">futures <span class="cm-keyword">import <span class="cm-variable">ThreadPoolExecutor<br /><span><span class="cm-comment"># ProcessPoolExecutor 该模块下还有一个进程池,与multi 功能相同<br /><span><span class="cm-comment"># submit(fn,*args,**kwargs) 异步提交任务<br /><span><span class="cm-comment"># map(fun,*iterables,timeout=None,chunksize - 1) 循环的submit<br /><span><span class="cm-comment"># shutdown(wait=True) # 等于原来的 close join 合并<br /><span><span class="cm-comment"># result(time=None) 取得结果<br /><span><span class="cm-comment"># add_done_callback(fn) 回调函数<br /><span><span class="cm-keyword">def <span class="cm-def">func(<span class="cm-variable">n):<br /><span> &nbsp; &nbsp;<span class="cm-variable">time.<span class="cm-property">sleep(<span class="cm-number">2)<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-variable">n)<br /><span> &nbsp; &nbsp;<span class="cm-keyword">return <span class="cm-variable">n<span class="cm-operator">*<span class="cm-variable">n<br /><span><span class="cm-keyword">def <span class="cm-def">call_back(<span class="cm-variable">m):<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-string">'结果是 %s'<span class="cm-operator">%<span class="cm-variable">m.<span class="cm-property">result())<br /><span><span class="cm-comment"># 若使用进程池 只换ThreadPoolExecutor-&gt;ProcessPoolExecutor<br /><span><span class="cm-variable">tpool = <span class="cm-variable">ThreadPoolExecutor(<span class="cm-variable">max_workers=<span class="cm-number">5) &nbsp; <span class="cm-comment">#  默认 不要超过cpu个数*5<br /><span><span class="cm-keyword">for <span class="cm-variable">i <span class="cm-keyword">in <span class="cm-builtin">range(<span class="cm-number">20):<br /><span> &nbsp; &nbsp;<span class="cm-variable">tpool.<span class="cm-property">submit(<span class="cm-variable">func,<span class="cm-variable">i).<span class="cm-property">add_done_callback(<span class="cm-variable">call_back)<br /><span><span class="cm-variable">tpool.<span class="cm-property">shutdown()<br /><span><span class="cm-comment"># tpool.map(func,range(20))  # 拿不到返回值<br /><span><span>​<br /><span><span class="cm-comment"># t_lst = []<br /><span><span class="cm-comment"># for i in  range(20):<br /><span><span class="cm-comment"># &nbsp; &nbsp; t = tpool.submit(func,i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; t_lst.append(t)<br /><span><span class="cm-comment"># tpool.shutdown()  # close+join &nbsp;  #<br /><span><span class="cm-comment"># print('主线程')<br /><span><span class="cm-comment"># for t in t_lst:print('***',t.result()) # 拿返回值</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">6<span>_<span class="md-plain">协程</span></span></span></h1>
<p class="md-end-block md-p">&nbsp;</p>
<div class="code-wrapper"><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-comment"># 进程 多个进程,操作系统负责<br /><span><span class="cm-comment"># 线程 不能同一时间多个cup 其他语言可以,但不影响高io<br /><span><span class="cm-comment"># &nbsp; 开启线程 创建线程 寄存器 堆栈<br /><span><span class="cm-comment"># &nbsp; 关闭一个线程<br /><span><span class="cm-comment"># 协程<br /><span><span class="cm-comment"># &nbsp; 本质是一个线程<br /><span><span class="cm-comment"># &nbsp; 能够在多个任务间切换,不需要寄存器,堆栈切换<br /><span><span class="cm-comment"># &nbsp; 任务之间切换时间开销 远小于线程<br /><span><span class="cm-comment"># &nbsp; 计算任务之间切换消耗也很大,一般都是遇到io的时候切换<br /><span><span class="cm-comment"># &nbsp; 进程(cup数+1)+线程(cup数*5)+协程(500)  = 50000<br /><span><span class="cm-comment"># &nbsp; 适合爬虫<br /><span><span class="cm-comment"># 实现并发的手段<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># 实现在 con,pro之间来回切换<br /><span><span class="cm-comment"># def consumer():<br /><span><span class="cm-comment"># &nbsp; &nbsp; while True:<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; x = yield<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print('处理了数据 :',x)<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def producer():<br /><span><span class="cm-comment"># &nbsp; &nbsp; c = consumer()<br /><span><span class="cm-comment"># &nbsp; &nbsp; next(c)<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; print('生产了数据 :',i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; c.send(i)<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># producer()<br /><span><span class="cm-comment"># =============================================<br /><span><span class="cm-comment"># 真正的协程模块就是使用greenlet完成的切换<br /><span><span class="cm-keyword">from <span class="cm-variable">greenlet <span class="cm-keyword">import <span class="cm-variable">greenlet<br /><span><span class="cm-comment"># def eat():<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('eating start')<br /><span><span class="cm-comment"># &nbsp; &nbsp; g2.switch()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('eating end')<br /><span><span class="cm-comment"># &nbsp; &nbsp; g2.switch()<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def play():<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('playing start')<br /><span><span class="cm-comment"># &nbsp; &nbsp; g1.switch()<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('playing end')<br /><span><span class="cm-comment"># g1 = greenlet(eat)  # 必须先有g1 ,g2 函数中才能使用g<br /><span><span class="cm-comment"># g2 = greenlet(play) # 不会自动切换<br /><span><span class="cm-comment"># g1.switch()<br /><span><span class="cm-comment"># ======================================<br /><span><span class="cm-comment">#  不能感知time.sleep(1)<br /><span><span class="cm-comment"># 可以感知gevent.sleep(1),在第一行引入 如下from...<br /><span><span class="cm-comment"># 后边的time 都会经过特殊处理,time.sleep() 就可以被识别<br /><span><span class="cm-comment"># from gevent import monkey;monkey.patch_all()<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># import gevent<br /><span><span class="cm-comment"># import threading<br /><span><span class="cm-comment"># def eat():<br /><span><span class="cm-comment"># &nbsp; &nbsp; DummyThread-1 虚拟的线程<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(threading.current_thread().getName())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(threading.current_thread())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('eating start')<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('eating end')<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># def play():<br /><span><span class="cm-comment"># &nbsp; &nbsp; DummyThread-2 虚拟的线程<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(threading.current_thread().getName())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(threading.current_thread())<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('playing start')<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print('playing end')<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># g1 = gevent.spawn(eat) # 注册进入,会自动切换,不是操作系统调度<br /><span><span class="cm-comment"># g2 = gevent.spawn(play) # gevent 负责协程的调度 通过封装的greenlet switch<br /><span><span class="cm-comment"># g1.join()  gevent 是完全异步的  join等待协程结束<br /><span><span class="cm-comment"># g2.join()<br /><span><span class="cm-comment"># 进程和线程的任务切换右操作系统完成<br /><span><span class="cm-comment"># 协程任务之间的切换由程序(代码)完成,只有遇到协程模块能识别的IO操作,(时间片等不识别)的时候,程序才会进行任务切换,实现并发的效果<br /><span><span class="cm-comment"># ========================================<br /><span><span class="cm-comment"># 同步 和 异步<br /><span><span class="cm-comment"># from gevent import monkey;monkey.patch_all() # 放最前面<br /><span><span class="cm-comment"># import time<br /><span><span class="cm-comment"># import gevent<br /><span><span class="cm-comment"># def task(n):<br /><span><span class="cm-comment"># &nbsp; &nbsp; time.sleep(1)<br /><span><span class="cm-comment"># &nbsp; &nbsp; print(n)<br /><span><span class="cm-comment"># def sync(): # 同步<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; task(i)<br /><span><span class="cm-comment"># def async(): # 异步<br /><span><span class="cm-comment"># &nbsp; &nbsp; g_lst = []<br /><span><span class="cm-comment"># &nbsp; &nbsp; for i in range(10):<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; g = gevent.spawn(task,i)<br /><span><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; g_lst.append(g)<br /><span><span class="cm-comment"># &nbsp; &nbsp; gevent.joinall(g_lst) &nbsp; #两种方法都可<br /><span><span class="cm-comment"># &nbsp; &nbsp; for g in g_lst:g.join()<br /><span><span class="cm-comment"># ======================================<br /><span><span class="cm-comment"># 协程 : 能够在一个线程中实现并发效果的概念<br /><span> &nbsp; &nbsp;<span class="cm-comment"># &nbsp;  能够规避一些任务中的IO操作<br /><span> &nbsp; &nbsp;<span class="cm-comment"># &nbsp;  在任务的执行过程中,检测到IO就切换到其他任务<br /><span><span>​<br /><span><span class="cm-comment"># 多线程 被弱化了<br /><span><span class="cm-comment"># 协程 在一个线程上 提高CPU 的利用率<br /><span><span class="cm-comment"># 协程相比于多线程的优势 切换的效率更快<br /><span><span class="cm-comment"># ==========================================<br /><span><span class="cm-comment"># 爬虫的例子<br /><span><span class="cm-comment"># 请求过程中的IO等待<br /><span><span class="cm-comment"># from gevent import monkey;monkey.patch_all()<br /><span><span class="cm-comment"># import gevent<br /><span><span class="cm-comment"># from urllib.request import urlopen &nbsp;  # 内置的模块<br /><span><span class="cm-comment"># urlopen html时有个格式的 reguests 无格式<br /><span><span class="cm-comment"># def get_url(url):<br /><span><span class="cm-comment"># &nbsp; &nbsp; response = urlopen(url)<br /><span><span class="cm-comment"># &nbsp; &nbsp; content = response.read().decode('utf-8')<br /><span><span class="cm-comment"># &nbsp; &nbsp; return len(content)<br /><span><span class="cm-comment">#<br /><span><span class="cm-comment"># g1 = gevent.spawn(get_url,'http://www.baidu.com')<br /><span><span class="cm-comment"># g2 = gevent.spawn(get_url,'http://www.sogou.com')<br /><span><span class="cm-comment"># g3 = gevent.spawn(get_url,'http://www.taobao.com')<br /><span><span class="cm-comment"># g4 = gevent.spawn(get_url,'http://www.hao123.com')<br /><span><span class="cm-comment"># g5 = gevent.spawn(get_url,'http://www.cnblogs.com')<br /><span><span class="cm-comment"># gevent.joinall([g1,g2,g3,g4,g5])<br /><span><span class="cm-comment"># print(g1.value)<br /><span><span class="cm-comment"># print(g2.value)<br /><span><span class="cm-comment"># print(g3.value)<br /><span><span class="cm-comment"># print(g4.value)<br /><span><span class="cm-comment"># print(g5.value)<br /><span><span>​<br /><span><span class="cm-comment"># ret = get_url('http://www.baidu.com')<br /><span><span class="cm-comment"># print(ret)<br /><span><span class="cm-comment"># ======================================<br /><span><span class="cm-keyword">from <span class="cm-variable">gevent <span class="cm-keyword">import <span class="cm-variable">monkey;<span class="cm-variable">monkey.<span class="cm-property">patch_all()<br /><span><span class="cm-keyword">import <span class="cm-variable">socket<br /><span><span class="cm-keyword">import <span class="cm-variable">gevent<br /><span><span class="cm-keyword">def <span class="cm-def">talk(<span class="cm-variable">conn):<br /><span> &nbsp; &nbsp;<span class="cm-variable">conn.<span class="cm-property">send(<span class="cm-string">b'hello')<br /><span> &nbsp; &nbsp;<span class="cm-builtin">print(<span class="cm-variable">conn.<span class="cm-property">recv(<span class="cm-number">1024).<span class="cm-property">decode(<span class="cm-string">'utf-8'))<br /><span> &nbsp; &nbsp;<span class="cm-variable">conn.<span class="cm-property">close()<br /><span><span>​<br /><span><span class="cm-variable">sk = <span class="cm-variable">socket.<span class="cm-property">socket()<br /><span><span class="cm-variable">sk.<span class="cm-property">bind((<span class="cm-string">'127.0.0.1',<span class="cm-number">8080))<br /><span><span class="cm-variable">sk.<span class="cm-property">listen()<br /><span><span class="cm-keyword">while <span class="cm-keyword">True:<br /><span> &nbsp; &nbsp;<span class="cm-variable">conn,<span class="cm-variable">addr = <span class="cm-variable">sk.<span class="cm-property">accept()<br /><span> &nbsp; &nbsp;<span class="cm-variable">gevent.<span class="cm-property">spawn(<span class="cm-variable">talk,<span class="cm-variable">conn)<br /><span><span class="cm-variable">sk.<span class="cm-property">close()<br /><span><span>​<br /><span><span class="cm-keyword">import <span class="cm-variable">socket<br /><span><span class="cm-variable">sk = <span class="cm-variable">socket.<span class="cm-property">socket()<br /><span><span class="cm-variable">sk.<span class="cm-property">connect((<span class="cm-string">'127.0.0.1',<span class="cm-number">8080))<br /><span><span class="cm-builtin">print(<span class="cm-variable">sk.<span class="cm-property">recv(<span class="cm-number">1024))<br /><span><span class="cm-variable">msg = <span class="cm-builtin">input(<span class="cm-string">'&gt;&gt;&gt;').<span class="cm-property">encode(<span class="cm-string">'utf-8')<br /><span><span class="cm-variable">sk.<span class="cm-property">send(<span class="cm-variable">msg)<br /><span><span class="cm-variable">sk.<span class="cm-property">close()</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></div>
<h1 class="md-end-block md-heading"><span class="md-plain">7<span>_<span class="md-plain">io模型</span></span></span></h1>
<h2 class="md-end-block md-heading"><span class="md-plain">阻塞模型</span></h2>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">非阻塞模型</span></h2>
<p class="md-end-block md-p">&nbsp;</p>
<h2 class="md-end-block md-heading"><span class="md-plain">io多路复用</span></h2>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<p class="md-end-block md-p">&nbsp;</p>
<div class="code-wrapper"><pre class="md-fences mock-cm md-end-block"># 同步 提交一个任务之后要等待这个任务执行完毕
# 异步 只管提交任务,不等待这个任务执行完毕就可以做其他事情
# 阻塞 recv recvfrom accept
# 非阻塞

<h1 id="阻塞-线程-运行状态-–-gt-阻塞状态-–-gt-就绪"><a href="#阻塞-线程-运行状态-–-gt-阻塞状态-–-gt-就绪" class="headerlink" title="阻塞   线程   运行状态 –&gt; 阻塞状态 –&gt; 就绪"></a>阻塞   线程   运行状态 –&gt; 阻塞状态 –&gt; 就绪</h1><h1 id="非阻塞"><a href="#非阻塞" class="headerlink" title="非阻塞"></a>非阻塞</h1><h1 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h1><pre><code class="hljs"># select机制  Windows  linux  都是操作系统轮询每一个被监听的项,看是否有读操作
# poll机制    linux          它可以监听的对象比select机制可以监听的数量多
                             # 随着监听项的增多,导致效率降低
# epoll机制   linux           更高级,绑定回调函数,
</code></pre></div>
<h1 id=""><a href="#" class="headerlink" title="================================="></a>=================================</h1><h1 id="以前的都是阻塞io"><a href="#以前的都是阻塞io" class="headerlink" title="以前的都是阻塞io"></a>以前的都是阻塞io</h1><h1 id="-1"><a href="#-1" class="headerlink" title="================================="></a>=================================</h1><h1 id="非阻塞io实例"><a href="#非阻塞io实例" class="headerlink" title="非阻塞io实例"></a>非阻塞io实例</h1><h1 id="import-socket"><a href="#import-socket" class="headerlink" title="import socket"></a>import socket</h1><h1 id="sk-socket-socket"><a href="#sk-socket-socket" class="headerlink" title="sk = socket.socket()"></a>sk = socket.socket()</h1><h1 id="sk-bind-‘127-0-0-1’-9000"><a href="#sk-bind-‘127-0-0-1’-9000" class="headerlink" title="sk.bind((‘127.0.0.1’,9000))"></a>sk.bind((‘127.0.0.1’,9000))</h1><h1 id="sk-setblocking-False-设置不阻塞"><a href="#sk-setblocking-False-设置不阻塞" class="headerlink" title="sk.setblocking(False)  # 设置不阻塞"></a>sk.setblocking(False)  # 设置不阻塞</h1><h1 id="sk-listen"><a href="#sk-listen" class="headerlink" title="sk.listen()"></a>sk.listen()</h1><h1 id="conn-l"><a href="#conn-l" class="headerlink" title="conn_l = []"></a>conn_l = []</h1><h1 id="del-conn"><a href="#del-conn" class="headerlink" title="del_conn = []"></a>del_conn = []</h1><h1 id="while-True"><a href="#while-True" class="headerlink" title="while True:"></a>while True:</h1><h1 id="try"><a href="#try" class="headerlink" title="try:"></a>try:</h1><h1 id="conn-addr-sk-accept-不阻塞-但是没人连我会报错"><a href="#conn-addr-sk-accept-不阻塞-但是没人连我会报错" class="headerlink" title="conn,addr = sk.accept()  #不阻塞,但是没人连我会报错"></a>conn,addr = sk.accept()  #不阻塞,但是没人连我会报错</h1><h1 id="print-‘建立连接了-’-addr"><a href="#print-‘建立连接了-’-addr" class="headerlink" title="print(‘建立连接了:’,addr)"></a>print(‘建立连接了:’,addr)</h1><h1 id="conn-l-append-conn"><a href="#conn-l-append-conn" class="headerlink" title="conn_l.append(conn)"></a>conn_l.append(conn)</h1><h1 id="except-BlockingIOError"><a href="#except-BlockingIOError" class="headerlink" title="except BlockingIOError:"></a>except BlockingIOError:</h1><h1 id="for-con-in-conn-l"><a href="#for-con-in-conn-l" class="headerlink" title="for con in conn_l:"></a>for con in conn_l:</h1><h1 id="try-1"><a href="#try-1" class="headerlink" title="try:"></a>try:</h1><h1 id="msg-con-recv-1024-非阻塞-如果没有数据就报错"><a href="#msg-con-recv-1024-非阻塞-如果没有数据就报错" class="headerlink" title="msg = con.recv(1024)  # 非阻塞,如果没有数据就报错"></a>msg = con.recv(1024)  # 非阻塞,如果没有数据就报错</h1><h1 id="if-msg-b’’-若客户端关闭-会发送空消息"><a href="#if-msg-b’’-若客户端关闭-会发送空消息" class="headerlink" title="if msg == b’’:   # 若客户端关闭 会发送空消息"></a>if msg == b’’:   # 若客户端关闭 会发送空消息</h1><h1 id="del-conn-append-con"><a href="#del-conn-append-con" class="headerlink" title="del_conn.append(con)"></a>del_conn.append(con)</h1><h1 id="continue"><a href="#continue" class="headerlink" title="continue"></a>continue</h1><h1 id="print-msg"><a href="#print-msg" class="headerlink" title="print(msg)"></a>print(msg)</h1><h1 id="con-send-b’byebye’"><a href="#con-send-b’byebye’" class="headerlink" title="con.send(b’byebye’)"></a>con.send(b’byebye’)</h1><h1 id="except-BlockingIOError-pass"><a href="#except-BlockingIOError-pass" class="headerlink" title="except BlockingIOError:pass"></a>except BlockingIOError:pass</h1><h1 id="for-con-in-del-conn"><a href="#for-con-in-del-conn" class="headerlink" title="for con in del_conn:"></a>for con in del_conn:</h1><h1 id="con-close"><a href="#con-close" class="headerlink" title="con.close()"></a>con.close()</h1><h1 id="conn-l-remove-con"><a href="#conn-l-remove-con" class="headerlink" title="conn_l.remove(con)"></a>conn_l.remove(con)</h1><h1 id="del-conn-clear"><a href="#del-conn-clear" class="headerlink" title="del_conn.clear()"></a>del_conn.clear()</h1><h1 id="while-True-10000-500-501"><a href="#while-True-10000-500-501" class="headerlink" title="# while True : 10000   500  501"></a># while True : 10000   500  501</h1><h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><h1 id="import-time"><a href="#import-time" class="headerlink" title="import time"></a>import time</h1><h1 id="import-socket-1"><a href="#import-socket-1" class="headerlink" title="import socket"></a>import socket</h1><h1 id="import-threading"><a href="#import-threading" class="headerlink" title="import threading"></a>import threading</h1><h1 id="def-func"><a href="#def-func" class="headerlink" title="def func():"></a>def func():</h1><h1 id="sk-socket-socket-1"><a href="#sk-socket-socket-1" class="headerlink" title="sk = socket.socket()"></a>sk = socket.socket()</h1><h1 id="sk-connect-‘127-0-0-1’-9000"><a href="#sk-connect-‘127-0-0-1’-9000" class="headerlink" title="sk.connect((‘127.0.0.1’,9000))"></a>sk.connect((‘127.0.0.1’,9000))</h1><h1 id="sk-send-b’hello’"><a href="#sk-send-b’hello’" class="headerlink" title="sk.send(b’hello’)"></a>sk.send(b’hello’)</h1><h1 id="time-sleep-1"><a href="#time-sleep-1" class="headerlink" title="time.sleep(1)"></a>time.sleep(1)</h1><h1 id="print-sk-recv-1024"><a href="#print-sk-recv-1024" class="headerlink" title="print(sk.recv(1024))"></a>print(sk.recv(1024))</h1><h1 id="sk-close"><a href="#sk-close" class="headerlink" title="sk.close()"></a>sk.close()</h1><h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><h1 id="for-i-in-range-2"><a href="#for-i-in-range-2" class="headerlink" title="for i in range(2):"></a>for i in range(2):</h1><h1 id="threading-Thread-target-func-start"><a href="#threading-Thread-target-func-start" class="headerlink" title="threading.Thread(target=func).start()"></a>threading.Thread(target=func).start()</h1><h1 id="-4"><a href="#-4" class="headerlink" title="================================="></a>=================================</h1><h1 id="io-多路复用-监听列表的循环-变为有操作系统执行"><a href="#io-多路复用-监听列表的循环-变为有操作系统执行" class="headerlink" title="io 多路复用, 监听列表的循环 变为有操作系统执行"></a>io 多路复用, 监听列表的循环 变为有操作系统执行</h1><p>import select<br>import socket</p>
<p>sk = socket.socket()<br>sk.bind((‘127.0.0.1’,8000))<br>sk.setblocking(False)<br>sk.listen()</p>
<p>read_lst = [sk] # 监听列表<br>while True:   # [sk,conn]<br>    # 等待读列表,写列表,修改列表 都必传<br>    # 返回元祖中3个列表,对应三个list,一般只用第一个<br>    # r_lst里面就是sk对象<br>    r_lst,w_lst,x_lst = select.select(read_lst,[],[])<br>    for i in r_lst:<br>        if i is sk:<br>            conn,addr = i.accept()<br>            read_lst.append(conn)<br>        else:<br>            ret = i.recv(1024)<br>            if ret == b’’:<br>                i.close()<br>                read_lst.remove(i)<br>                continue<br>            print(ret)<br>            i.send(b’goodbye!’)<br>            import time<br>            import socket<br>            import threading</p>
<div class="code-wrapper"><pre><code class="hljs">        def func():
            sk = socket.socket()
            sk.connect((&#39;127.0.0.1&#39;, 8000))
            sk.send(b&#39;hello&#39;)
            time.sleep(3)
            print(sk.recv(1024))
            sk.close()
        for i in range(20):
            threading.Thread(target=func).start()
</code></pre></div>
<h1 id="-5"><a href="#-5" class="headerlink" title="================================="></a>=================================</h1><p>import selectors # 选择合适的多路复用机制<br>from socket import *</p>
<p>def accept(sk,mask):<br>    conn,addr=sk.accept()<br>    sel.register(conn,selectors.EVENT_READ,read)</p>
<p>def read(conn,mask):<br>    try:<br>        data=conn.recv(1024)<br>        if not data:<br>            print(‘closing’,conn)<br>            sel.unregister(conn)<br>            conn.close()<br>            return<br>        conn.send(data.upper()+b’_SB’)<br>    except Exception:<br>        print(‘closing’, conn)<br>        sel.unregister(conn)<br>        conn.close()</p>
<p>sk=socket()<br>sk.setsockopt(SOL_SOCKET,SO_REUSEADDR,1)<br>sk.bind((‘127.0.0.1’,8088))<br>sk.listen(5)<br>sk.setblocking(False) #设置socket的接口为非阻塞</p>
<p>sel = selectors.DefaultSelector()   # 自动选择一个适合我的IO多路复用的机制<br>sel.register(sk,selectors.EVENT_READ,accept)<br>#相当于网select的读列表里append了一个sk对象,并且绑定了一个回调函数accept</p>
<h1 id="说白了就是-如果有人请求连接sk-就调用accrpt方法"><a href="#说白了就是-如果有人请求连接sk-就调用accrpt方法" class="headerlink" title="说白了就是 如果有人请求连接sk,就调用accrpt方法"></a>说白了就是 如果有人请求连接sk,就调用accrpt方法</h1><p>while True:<br>    events=sel.select() #检测所有的sk,conn，是否有完成wait data阶段<br>    for sel_obj,mask in events:  # [conn]<br>        callback=sel_obj.data #callback=read<br>        callback(sel_obj.fileobj,mask) #read(conn,1)<br></pre></p>
<h1 class="md-end-block md-heading"><span class="md-plain">pymysql</span></h1>
<div class="code-wrapper"><pre class="md-fences mock-cm md-end-block">import pymysql
# 连接
conn = pymysql.connect(
    host="106.15.39.74",
    port=3306,
    database="test",
    user="root",
    password="dzf123,.",
    charset="utf8" # 没有"-" 没有
)
cursor = conn.cursor()
sql = "select*from student"
name = "dzf"
password = "123456"
sql = "select * from student where name = %s and password = %s"
ret = cursor.execute(sql,[name,password])
# 自己拼接需要加引号,使用防注入sql不用加引号,参数不能少,多
#print(cursor.lastrowid) # 获取刚插入数据的id 应该就是主键 自增的那个,与名字无关
print(ret) # 返回受影响行数
ret = cursor.fetchall() # 元祖 大元组里边小元祖
print(ret,"a")
ret = cursor.fetchone() # 取一条数据
print(ret,"a")
ret = cursor.fetchone()
print(ret,"a")
# 直接返回一条元素,格式是 小元祖,或只有list中的一个小字典,外边没有元祖或list
# 若连续fetchone() 第一次第一条,第二次第二条,一次向下取
# 若取完后 再次 fetchone() 取不到
# --&gt;(('dzf','1234'),('dzf','1234'))
# 在执行语句前 修改cursor格式
cursor.fetchmany(3) # 在cursor位置接下取3条,大元组中小元祖
# 移动光标
cursor.scroll(1,mode="absolute") # 绝对移动 移到1位置,从2开始 ,
cursor.scroll(1,mode="relative") # 相对移动 原来在3 位置,从4 开始读,现在 移动到4 从5开始读
# 向上移可以使用负的
cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) # 指定为字典格式
"""
    [
    {'id':1,'name':'dzf'},
    {'id':1,'name':'dzf'},
    ]
"""

<p>cursor.close()<br>conn.close()</p>
<h1 id="-6"><a href="#-6" class="headerlink" title="===================================="></a>====================================</h1><h1 id="插入数据还是用cursor-execute-注意提交后conn-commit"><a href="#插入数据还是用cursor-execute-注意提交后conn-commit" class="headerlink" title="插入数据还是用cursor.execute(),注意提交后conn.commit()"></a>插入数据还是用cursor.execute(),注意提交后conn.commit()</h1><h1 id="若多语句-可能错误-conn-rollback"><a href="#若多语句-可能错误-conn-rollback" class="headerlink" title="若多语句,可能错误,conn.rollback()"></a>若多语句,可能错误,conn.rollback()</h1><h1 id="sql2-“insert-into-student-name-password-values-s-s-”"><a href="#sql2-“insert-into-student-name-password-values-s-s-”" class="headerlink" title="sql2 = “insert into student (name,password) values(%s, %s)”"></a>sql2 = “insert into student (name,password) values(%s, %s)”</h1><h1 id="ret-cursor-execute-sql2-‘123’-’123’"><a href="#ret-cursor-execute-sql2-‘123’-’123’" class="headerlink" title="ret = cursor.execute(sql2,[‘123’,’123’])"></a>ret = cursor.execute(sql2,[‘123’,’123’])</h1><h1 id="conn-commit"><a href="#conn-commit" class="headerlink" title="conn.commit()"></a>conn.commit()</h1><h1 id="或insert-into-student-name-password-values-name-s-pwd-s"><a href="#或insert-into-student-name-password-values-name-s-pwd-s" class="headerlink" title="或insert into student (name,password) values(%(name)s, %(pwd)s)"></a>或insert into student (name,password) values(%(name)s, %(pwd)s)</h1><h1 id="下边传入字典excute-sql-“name”-xxx"><a href="#下边传入字典excute-sql-“name”-xxx" class="headerlink" title="下边传入字典excute(sql,{“name”:xxx..})"></a>下边传入字典excute(sql,{“name”:xxx..})</h1><h1 id="-7"><a href="#-7" class="headerlink" title="===================================="></a>====================================</h1><h1 id="批量执行"><a href="#批量执行" class="headerlink" title="批量执行"></a>批量执行</h1><p>data = ([‘12’,’12’],[‘23’,’32’],[‘32’,’23’]) # 格式必须固定<br>cursor.executemany(sql,data)  # 内部的for循环</p>
<h1 id="try-防止异常-要回滚-会取消以前正确的插入语句"><a href="#try-防止异常-要回滚-会取消以前正确的插入语句" class="headerlink" title="try 防止异常,要回滚, 会取消以前正确的插入语句"></a>try 防止异常,要回滚, 会取消以前正确的插入语句</h1><h1 id="-8"><a href="#-8" class="headerlink" title="================================="></a>=================================</h1><h1 id="删除-同理-也要提交"><a href="#删除-同理-也要提交" class="headerlink" title="删除,同理,也要提交"></a>删除,同理,也要提交</h1><h1 id="-9"><a href="#-9" class="headerlink" title="================================"></a>================================</h1><h1 id="修改-记得提交"><a href="#修改-记得提交" class="headerlink" title="修改 记得提交"></a>修改 记得提交</h1><p></pre></div></p>
<p>&nbsp;</p>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/01/16/cnblog/Python%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/16/cnblog/python%E5%9F%BA%E7%A1%80/">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
